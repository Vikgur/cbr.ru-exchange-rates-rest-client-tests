# Оглавление

1. [Демонстрационный проект: Проверка курсов валют с cbr.ru](#демонстрационный-проект-проверка-курсов-валют-с-cbrru)  
2. [Чек-лист тестов](#чек-лист-тестов)  
3. [Инструкция по запуску проекта](#инструкция-по-запуску-проекта) 

# Демонстрационный проект: Проверка курсов валют с cbr.ru

## Описание

Этот проект — реализация REST-клиента для проверки корректности курсов валют, предоставляемых сайтом [cbr-xml-daily](https://www.cbr-xml-daily.ru/#:~:text=%D0%9A%D1%80%D0%BE%D0%BC%D0%B5%20%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%20%D1%81%20%D0%BA%D1%83%D1%80%D1%81%D0%B0%D0%BC%D0%B8%20%D0%B2%20%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B5%20XML%20%D0%BD%D0%B0%20%D0%BD%D0%B0%D1%88%D0%B5%D0%BC%20%D1%80%D0%B5%D1%81%D1%83%D1%80%D1%81%D0%B5%20%D0%B2%D1%8B%20%D0%BC%D0%BE%D0%B6%D0%B5%D1%82%D0%B5%20%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C%20%D0%BA%D1%83%D1%80%D1%81%D1%8B%20%D0%B2%D0%B0%D0%BB%D1%8E%D1%82%20%D0%B2%20%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B5%20JSON%20%D0%B8%20%D0%BA%D1%83%D1%80%D1%81%D1%8B%20%D0%A6%D0%91%20%D0%A0%D0%A4%20%D0%B2%20%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B5%20JSONP%3A).  

Метод полностью покрыт тестами, с автосохранением логов выполнения в папку `logs` и формированием детализированных Allure-отчётов для каждого шага.  

Для повышения читаемости и переиспользования кода тесты реализованы с использованием параметризации.

Проект написан на **Python** с использованием **pytest** для тестирования.

В `tests/conftest.py` настроены две ключевые фикстуры:
- **REST клиент для тестов** — создаёт клиента для взаимодействия с API.
- **Хук для автологирования** — автоматически сохраняет логи всех тестов в папку `logs` в корне проекта.

Весь проект дополнительно проверен статическим анализатором **mypy**.

## Чек-лист тестов

### Проверка получения курсов валют для разных дат (`test_get_exchange_rates_various_dates`)
- [x] Успешный ответ для корректной даты (`2025-03-01`).
- [x] Ошибка для некорректного месяца (`2025-13-01`).
- [x] Ошибка для некорректного формата даты (`abcd-ef-gh`).
- [x] Ошибка для будущей даты (`2030-01-01`).
- [x] Ошибка для слишком старой даты (`1900-01-01`).

### Проверка переиспользования сессии (`test_session_reuse`)
- [x] REST клиент использует одну и ту же сессию между вызовами.

### Проверка обработки ошибок сервера (`test_get_exchange_rates_server_errors`)
- [x] API корректно обрабатывает ответ сервера с кодом 500.

### Проверка обработки ошибки 404 (`test_get_exchange_rates_404_error`)
- [x] API корректно обрабатывает ответ сервера с кодом 404 Not Found.

### Проверка обработки невалидного JSON (`test_get_exchange_rates_invalid_json`)
- [x] API корректно обрабатывает случай получения невалидного JSON от сервера.

### Проверка обработки сетевых ошибок (`test_get_exchange_rates_network_errors`)
- [x] API корректно обрабатывает сетевые ошибки и тайм-ауты.

## Результаты тестов
Скриншоты с успешным запуском тестов, лога и Allure отчет находятся в директории проекта `screenshots`.

---

## Особенности

- Поддержка работы с реальным API данных Центробанка РФ.
- Полное покрытие реальных сценариев запросов и обработки ошибок.
- Подробные Allure-отчёты для каждого шага всех тестов.
- Система автологирования результатов тестов.
- Статическая проверка кода с помощью **mypy**.

---

# Инструкция по запуску проекта

## 1. Установка Python

Убедитесь, что у вас установлен Python версии 3.10 или выше:

```bash
python3 --version
```

Если версия Python ниже 3.10, обновите Python перед продолжением.

## 2. Установка Poetry

Проверьте наличие Poetry:

```bash
poetry --version
```

Если Poetry не установлен, установите его командой:

```bash
curl -sSL https://install.python-poetry.org | python3 -
export PATH="$HOME/.local/bin:$PATH"
```

> Если команда `poetry` не распознаётся, убедитесь, что вы добавили Poetry в `PATH`.

## 3. Клонирование репозитория

Клонируйте проект и перейдите в его директорию:

```bash
git clone git@gitlab.com:Vikgur/cbr.ru-exchange-rates-rest-client-tests.git
cd cbr.ru-exchange-rates-rest-client-tests
```

## 4. Настройка виртуального окружения

Создайте виртуальное окружение на основе Python 3:

```bash
poetry env use python3
```

Установите зависимости проекта:

```bash
poetry install --with dev
```

> Файл poetry.lock добавлен в репозиторий для синхронизации версий зависимостей.

## 5. Запуск тестов

### Полный запуск тестов с подробным выводом параметризированных данных и покрытием `coverage`

```bash
poetry run coverage run -m pytest tests/test_*.py -v
poetry run coverage report -m | grep "tests/test_"
```

- Флаг `-v` включает подробный вывод всех параметризаций.
- `grep` фильтрует отчёт по строкам с тестовыми файлами для удобства просмотра.

### Запуск без подробного (`-v`) вывода

```bash
poetry run coverage run -m pytest tests/test_*.py
poetry run coverage report -m | grep "tests/test_"
```

### Обычный запуск тестов без покрытия `coverage`

```bash
poetry run pytest
```

## 6. Генерация и открытие отчета Allure

Полный процесс очистки старых данных и запуска нового отчета:

```bash
rm -rf allure-results allure-report
poetry run pytest --alluredir=allure-results
poetry run allure generate allure-results -o allure-report --clean
poetry run allure open allure-report
```

- Папки `allure-results` и `allure-report` удаляются перед каждым новым запуском для чистоты данных.
- Команда `allure open` автоматически откроет свежесгенерированный отчёт в браузере.
